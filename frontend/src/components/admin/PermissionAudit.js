import { useState, useEffect } from "react";
import { getPointHistory, getTrades } from "@/lib/api";
import { Clock, User, Activity, AlertCircle, Search, Filter, Download } from "lucide-react";

/**
 * Á≥ªÁµ±ÂØ©Ë®àÊó•Ë™å - È°û‰ºº Discord ÁöÑ‰º∫ÊúçÂô®ÂØ©Ë®àÊó•Ë™å
 * Ë®òÈåÑÂíåÈ°ØÁ§∫Á≥ªÁµ±‰∏≠ÁöÑÊâÄÊúâÈáçË¶ÅÊìç‰Ωú
 */
export const PermissionAudit = ({ token }) => {
    const [auditData, setAuditData] = useState({
        pointLogs: [],
        escrowLogs: [],
        tradeLogs: [],
        systemEvents: [],
        combinedLogs: [],
    });
    const [loading, setLoading] = useState(true);
    const [selectedTab, setSelectedTab] = useState("all");
    const [filters, setFilters] = useState({
        dateRange: "today",
        actionType: "all",
        userId: "",
        searchTerm: "",
    });
    const [pagination, setPagination] = useState({
        currentPage: 1,
        pageSize: 50,
        totalPages: 1,
    });

    useEffect(() => {
        fetchAuditData();
    }, [token, filters]);

    const fetchAuditData = async () => {
        try {
            setLoading(true);
            
            // ‰∏¶Ë°åÁç≤Âèñ‰∏çÂêåÈ°ûÂûãÁöÑÊó•Ë™åÊï∏Êìö
            const [pointHistoryResponse, transactionResponse] = await Promise.all([
                getPointHistory(token).catch(err => ({ point_logs: [] })),
                getTrades(token).catch(err => ({ trades: [] })),
            ]);

            // ËôïÁêÜÈªûÊï∏Êó•Ë™å
            const pointLogs = (pointHistoryResponse.point_logs || []).map(log => ({
                id: `point_${log.user_id}_${log.created_at}`,
                timestamp: log.created_at,
                type: "point_operation",
                action: log.type,
                user_id: log.user_id,
                details: {
                    amount: log.amount,
                    balance_after: log.balance_after,
                    note: log.note,
                },
                icon: "üí∞",
                color: "text-green-400",
            }));

            // ËôïÁêÜ‰∫§ÊòìÊó•Ë™å
            const tradeLogs = (transactionResponse.trades || []).map(trade => ({
                id: `trade_${trade.id}`,
                timestamp: trade.timestamp,
                type: "trade_operation",
                action: "TRADE",
                user_id: trade.buyer_id || trade.seller_id,
                details: {
                    price: trade.price,
                    quantity: trade.quantity,
                    total_value: trade.total_value,
                    buyer_id: trade.buyer_id,
                    seller_id: trade.seller_id,
                },
                icon: "üìä",
                color: "text-blue-400",
            }));

            // Ê®°Êì¨Á≥ªÁµ±‰∫ã‰ª∂ÔºàÂü∫ÊñºÂ∑≤Áü•ÁöÑÁ≥ªÁµ±Êìç‰ΩúÔºâ
            const systemEvents = generateSystemEvents();

            // Âêà‰ΩµÊâÄÊúâÊó•Ë™å
            const combinedLogs = [...pointLogs, ...tradeLogs, ...systemEvents]
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 1000); // ÈôêÂà∂ÊúÄÂ§ö1000Ê¢ùË®òÈåÑ

            setAuditData({
                pointLogs,
                tradeLogs,
                systemEvents,
                combinedLogs: applyFilters(combinedLogs),
            });

            // Êõ¥Êñ∞ÂàÜÈ†Å
            const filteredLogs = applyFilters(combinedLogs);
            setPagination(prev => ({
                ...prev,
                totalPages: Math.ceil(filteredLogs.length / prev.pageSize),
            }));

        } catch (error) {
            console.error("Failed to fetch audit data:", error);
        } finally {
            setLoading(false);
        }
    };

    const generateSystemEvents = () => {
        // Ê®°Êì¨Á≥ªÁµ±‰∫ã‰ª∂ÔºåÂØ¶ÈöõÊáâÂæûÂæåÁ´ØÁç≤Âèñ
        const now = new Date();
        const events = [];
        
        // Ê®°Êì¨Â∏ÇÂ†¥ÈñãÈñâ‰∫ã‰ª∂
        const marketEvents = [
            { action: "market_open", note: "Â∏ÇÂ†¥ÈñãÂïü", time: -30 },
            { action: "market_close", note: "Â∏ÇÂ†¥ÈóúÈñâ", time: -60 },
            { action: "system_maintenance", note: "Á≥ªÁµ±Á∂≠Ë≠∑", time: -120 },
        ];

        marketEvents.forEach((event, index) => {
            events.push({
                id: `system_${index}`,
                timestamp: new Date(now.getTime() + event.time * 60000).toISOString(),
                type: "system_operation",
                action: event.action,
                user_id: "system",
                details: {
                    note: event.note,
                    automated: true,
                },
                icon: "üñ•Ô∏è",
                color: "text-purple-400",
            });
        });

        return events;
    };

    const applyFilters = (logs) => {
        let filtered = logs;

        // Êó•ÊúüÁØÑÂúçÈÅéÊøæ
        if (filters.dateRange !== "all") {
            const now = new Date();
            let startDate = new Date();
            
            switch (filters.dateRange) {
                case "today":
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case "week":
                    startDate.setDate(now.getDate() - 7);
                    break;
                case "month":
                    startDate.setMonth(now.getMonth() - 1);
                    break;
            }
            
            filtered = filtered.filter(log => 
                new Date(log.timestamp) >= startDate
            );
        }

        // Êìç‰ΩúÈ°ûÂûãÈÅéÊøæ
        if (filters.actionType !== "all") {
            filtered = filtered.filter(log => log.type === filters.actionType);
        }

        // Áî®Êà∂IDÈÅéÊøæ
        if (filters.userId) {
            filtered = filtered.filter(log => 
                log.user_id && log.user_id.toLowerCase().includes(filters.userId.toLowerCase())
            );
        }

        // ÊêúÁ¥¢ÈÅéÊøæ
        if (filters.searchTerm) {
            const searchTerm = filters.searchTerm.toLowerCase();
            filtered = filtered.filter(log => 
                log.action.toLowerCase().includes(searchTerm) ||
                (log.details.note && log.details.note.toLowerCase().includes(searchTerm)) ||
                (log.user_id && log.user_id.toLowerCase().includes(searchTerm))
            );
        }

        return filtered;
    };

    const formatTimestamp = (timestamp) => {
        return new Date(timestamp).toLocaleString('zh-TW', {
            timeZone: 'Asia/Taipei',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
        });
    };

    const formatActionName = (action) => {
        const actionMap = {
            "TRANSFER_IN": "ËΩâÂÖ•ÈªûÊï∏",
            "TRANSFER_OUT": "ËΩâÂá∫ÈªûÊï∏",
            "ADMIN_GIVE": "ÁÆ°ÁêÜÂì°Áµ¶‰∫à",
            "ADMIN_DEDUCT": "ÁÆ°ÁêÜÂì°Êâ£Èô§",
            "QR_REDEEM": "QRÁ¢ºÂÖåÊèõ",
            "TRADE": "ËÇ°Á•®‰∫§Êòì",
            "TRADE_BUY": "Ë≥ºË≤∑ËÇ°Á•®",
            "TRADE_SELL": "Âá∫ÂîÆËÇ°Á•®",
            "market_open": "Â∏ÇÂ†¥ÈñãÂïü",
            "market_close": "Â∏ÇÂ†¥ÈóúÈñâ",
            "system_maintenance": "Á≥ªÁµ±Á∂≠Ë≠∑",
            "ORDER_CREATE": "Âª∫Á´ãË®ÇÂñÆ",
            "ORDER_CANCEL": "ÂèñÊ∂àË®ÇÂñÆ",
            "ORDER_MATCH": "Ë®ÇÂñÆÊíÆÂêà",
        };
        return actionMap[action] || action;
    };

    const getActionColor = (type, action) => {
        const colorMap = {
            "point_operation": "text-green-400",
            "trade_operation": "text-blue-400", 
            "system_operation": "text-purple-400",
            "admin_operation": "text-orange-400",
            "user_operation": "text-cyan-400",
        };
        return colorMap[type] || "text-gray-400";
    };

    const getPaginatedLogs = () => {
        const startIndex = (pagination.currentPage - 1) * pagination.pageSize;
        const endIndex = startIndex + pagination.pageSize;
        return auditData.combinedLogs.slice(startIndex, endIndex);
    };

    // ÂØ©Ë®àÊó•Ë™åÈ†ÖÁõÆÁµÑ‰ª∂
    const AuditLogItem = ({ log }) => {
        const [expanded, setExpanded] = useState(false);

        return (
            <div className="bg-[#0f203e] border border-[#294565] rounded-lg p-4 hover:bg-[#1A325F] transition-colors">
                <div className="flex items-start space-x-3">
                    {/* ÂúñÁ§∫ */}
                    <div className="flex-shrink-0 w-8 h-8 bg-[#294565] rounded-full flex items-center justify-center text-sm">
                        {log.icon}
                    </div>

                    {/* ‰∏ªË¶ÅÂÖßÂÆπ */}
                    <div className="flex-1 min-w-0">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                                <span className={`font-medium ${getActionColor(log.type, log.action)}`}>
                                    {formatActionName(log.action)}
                                </span>
                                {log.user_id && log.user_id !== "system" && (
                                    <span className="text-[#7BC2E6] text-sm">
                                        by {log.user_id}
                                    </span>
                                )}
                            </div>
                            <div className="flex items-center space-x-2">
                                <span className="text-[#557797] text-sm">
                                    {formatTimestamp(log.timestamp)}
                                </span>
                                {Object.keys(log.details || {}).length > 0 && (
                                    <button
                                        onClick={() => setExpanded(!expanded)}
                                        className="text-[#7BC2E6] hover:text-[#92cbf4] text-sm"
                                    >
                                        {expanded ? "Êî∂Ëµ∑" : "Ë©≥ÊÉÖ"}
                                    </button>
                                )}
                            </div>
                        </div>

                        {/* Âü∫Êú¨‰ø°ÊÅØ */}
                        <div className="mt-1 text-sm text-[#7BC2E6]">
                            {log.type === "point_operation" && (
                                <span>
                                    {log.details.amount > 0 ? "+" : ""}{log.details.amount} ÈªûÊï∏
                                    {log.details.balance_after && ` (È§òÈ°ç: ${log.details.balance_after})`}
                                </span>
                            )}
                            {log.type === "trade_operation" && (
                                <span>
                                    {log.details.quantity} ËÇ° @ {log.details.price} ÈªûÊï∏
                                    {log.details.total_value && ` (Á∏ΩÂÉπ: ${log.details.total_value})`}
                                </span>
                            )}
                            {log.type === "system_operation" && (
                                <span>{log.details.note}</span>
                            )}
                        </div>

                        {/* Ë©≥Á¥∞‰ø°ÊÅØ */}
                        {expanded && (
                            <div className="mt-3 p-3 bg-[#294565] rounded border border-[#3A5A7E]">
                                <h4 className="text-sm font-medium text-[#92cbf4] mb-2">Ë©≥Á¥∞Ë≥áË®ä</h4>
                                <div className="space-y-1">
                                    {Object.entries(log.details || {}).map(([key, value]) => (
                                        <div key={key} className="flex justify-between text-sm">
                                            <span className="text-[#7BC2E6]">{key}:</span>
                                            <span className="text-[#92cbf4]">
                                                {typeof value === 'object' ? JSON.stringify(value) : String(value)}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    if (loading) {
        return (
            <div className="flex items-center justify-center p-8">
                <div className="text-center">
                    <div className="mx-auto mb-4 h-12 w-12 animate-spin rounded-full border-4 border-[#92cbf4] border-t-transparent"></div>
                    <p className="text-[#92cbf4]">ËºâÂÖ•ÂØ©Ë®àÊó•Ë™å‰∏≠...</p>
                </div>
            </div>
        );
    }

    return (
        <div className="bg-[#1A325F] rounded-lg shadow-lg border border-[#294565]">
            {/* È†ÅÈù¢Ê®ôÈ°å */}
            <div className="border-b border-[#294565] px-6 py-4">
                <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-2">
                        <Activity className="h-6 w-6 text-[#92cbf4]" />
                        <h2 className="text-xl font-bold text-[#92cbf4]">ÂØ©Ë®àÊó•Ë™å</h2>
                        <span className="text-sm text-[#7BC2E6]">
                            ÂÖ± {auditData.combinedLogs.length} Ê¢ùË®òÈåÑ
                        </span>
                    </div>
                    <button
                        onClick={fetchAuditData}
                        className="flex items-center space-x-2 bg-[#469FD2] text-white px-4 py-2 rounded hover:bg-[#5BAEE3] transition-colors"
                    >
                        <Clock className="h-4 w-4" />
                        <span>Âà∑Êñ∞</span>
                    </button>
                </div>
            </div>

            {/* ÁØ©ÈÅ∏Âô® */}
            <div className="border-b border-[#294565] px-6 py-4">
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    {/* Êó•ÊúüÁØÑÂúçÁØ©ÈÅ∏ */}
                    <div>
                        <label className="block text-sm font-medium text-[#7BC2E6] mb-1">
                            ÊôÇÈñìÁØÑÂúç
                        </label>
                        <select
                            value={filters.dateRange}
                            onChange={(e) => setFilters(prev => ({ ...prev, dateRange: e.target.value }))}
                            className="w-full bg-[#0f203e] border border-[#294565] rounded px-3 py-2 text-[#92cbf4] focus:outline-none focus:ring-2 focus:ring-[#469FD2]"
                        >
                            <option value="all">ÂÖ®ÈÉ®ÊôÇÈñì</option>
                            <option value="today">‰ªäÂ§©</option>
                            <option value="week">ÈÅéÂéª7Â§©</option>
                            <option value="month">ÈÅéÂéª30Â§©</option>
                        </select>
                    </div>

                    {/* Êìç‰ΩúÈ°ûÂûãÁØ©ÈÅ∏ */}
                    <div>
                        <label className="block text-sm font-medium text-[#7BC2E6] mb-1">
                            Êìç‰ΩúÈ°ûÂûã
                        </label>
                        <select
                            value={filters.actionType}
                            onChange={(e) => setFilters(prev => ({ ...prev, actionType: e.target.value }))}
                            className="w-full bg-[#0f203e] border border-[#294565] rounded px-3 py-2 text-[#92cbf4] focus:outline-none focus:ring-2 focus:ring-[#469FD2]"
                        >
                            <option value="all">ÂÖ®ÈÉ®È°ûÂûã</option>
                            <option value="point_operation">ÈªûÊï∏Êìç‰Ωú</option>
                            <option value="trade_operation">‰∫§ÊòìÊìç‰Ωú</option>
                            <option value="system_operation">Á≥ªÁµ±Êìç‰Ωú</option>
                            <option value="admin_operation">ÁÆ°ÁêÜÂì°Êìç‰Ωú</option>
                        </select>
                    </div>

                    {/* Áî®Êà∂ÁØ©ÈÅ∏ */}
                    <div>
                        <label className="block text-sm font-medium text-[#7BC2E6] mb-1">
                            Áî®Êà∂ID
                        </label>
                        <input
                            type="text"
                            value={filters.userId}
                            onChange={(e) => setFilters(prev => ({ ...prev, userId: e.target.value }))}
                            placeholder="ÊêúÁ¥¢Áî®Êà∂..."
                            className="w-full bg-[#0f203e] border border-[#294565] rounded px-3 py-2 text-[#92cbf4] placeholder-[#557797] focus:outline-none focus:ring-2 focus:ring-[#469FD2]"
                        />
                    </div>

                    {/* ÊêúÁ¥¢Ê°Ü */}
                    <div>
                        <label className="block text-sm font-medium text-[#7BC2E6] mb-1">
                            ÊêúÁ¥¢
                        </label>
                        <div className="relative">
                            <Search className="absolute left-3 top-2.5 h-4 w-4 text-[#557797]" />
                            <input
                                type="text"
                                value={filters.searchTerm}
                                onChange={(e) => setFilters(prev => ({ ...prev, searchTerm: e.target.value }))}
                                placeholder="ÊêúÁ¥¢Êìç‰Ωú..."
                                className="w-full bg-[#0f203e] border border-[#294565] rounded pl-10 pr-3 py-2 text-[#92cbf4] placeholder-[#557797] focus:outline-none focus:ring-2 focus:ring-[#469FD2]"
                            />
                        </div>
                    </div>
                </div>
            </div>

            {/* ÂØ©Ë®àÊó•Ë™åÂàóË°® */}
            <div className="p-6">
                {auditData.combinedLogs.length === 0 ? (
                    <div className="text-center py-12">
                        <AlertCircle className="h-12 w-12 text-[#557797] mx-auto mb-4" />
                        <p className="text-[#7BC2E6] text-lg">Ê≤íÊúâÊâæÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÊó•Ë™åË®òÈåÑ</p>
                        <p className="text-[#557797] text-sm mt-2">
                            Ë´ãÂòóË©¶Ë™øÊï¥ÁØ©ÈÅ∏Ê¢ù‰ª∂ÊàñÂà∑Êñ∞È†ÅÈù¢
                        </p>
                    </div>
                ) : (
                    <div className="space-y-2">
                        {getPaginatedLogs().map((log) => (
                            <AuditLogItem key={log.id} log={log} />
                        ))}
                    </div>
                )}

                {/* ÂàÜÈ†Å */}
                {auditData.combinedLogs.length > 0 && (
                    <div className="mt-6 flex items-center justify-between">
                        <div className="text-sm text-[#7BC2E6]">
                            È°ØÁ§∫ {(pagination.currentPage - 1) * pagination.pageSize + 1} - {Math.min(pagination.currentPage * pagination.pageSize, auditData.combinedLogs.length)} Ê¢ùÔºåÂÖ± {auditData.combinedLogs.length} Ê¢ùË®òÈåÑ
                        </div>
                        <div className="flex space-x-2">
                            <button
                                onClick={() => setPagination(prev => ({ ...prev, currentPage: Math.max(1, prev.currentPage - 1) }))}
                                disabled={pagination.currentPage === 1}
                                className="px-3 py-1 bg-[#0f203e] border border-[#294565] rounded text-[#92cbf4] hover:bg-[#294565] disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                ‰∏ä‰∏ÄÈ†Å
                            </button>
                            <span className="px-3 py-1 text-[#7BC2E6]">
                                {pagination.currentPage} / {pagination.totalPages}
                            </span>
                            <button
                                onClick={() => setPagination(prev => ({ ...prev, currentPage: Math.min(prev.totalPages, prev.currentPage + 1) }))}
                                disabled={pagination.currentPage === pagination.totalPages}
                                className="px-3 py-1 bg-[#0f203e] border border-[#294565] rounded text-[#92cbf4] hover:bg-[#294565] disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                ‰∏ã‰∏ÄÈ†Å
                            </button>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

export default PermissionAudit;